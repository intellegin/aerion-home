{% extends "layout.html" %}
{% block title %}System Settings{% endblock %}

{% block content %}
<style>
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input[type="text"], select, input[type="search"] { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; max-width: 400px; }
    .btn { padding: 0.8rem 1.5rem; border-radius: 4px; border: none; font-size: 1rem; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
    .btn-primary { background-color: #007bff; color: white; }
    .voice-list { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; max-width: 400px; }
    .voice-item { padding: 10px; cursor: pointer; }
    .voice-item:hover { background-color: #f1f1f1; }
    .voice-item.selected { background-color: #007bff; color: white; }
</style>

<h1>System Settings</h1>

<form id="settings-form">
    <h3>General Settings</h3>
    <div class="form-group">
        <label for="wake-word">Wake Word</label>
        <input type="text" id="wake-word" name="wake_word" placeholder="e.g., jarvis">
    </div>
    <div class="form-group">
        <label for="mic-device">Microphone</label>
        <select id="mic-device" name="mic_device_id"></select>
    </div>
    <div class="form-group">
        <label for="speaker-device">Speaker</label>
        <select id="speaker-device" name="speaker_device_id"></select>
    </div>

    <hr style="margin: 2rem 0;">

    <h3>Text-to-Speech Voice</h3>
    <p>Select a voice for the assistant. Voices are provided by <a href="https://elevenlabs.io/" target="_blank">ElevenLabs</a>.</p>
    <div class="form-group">
        <label for="voice-name">Select Voice</label>
        <input type="text" id="voice-name" list="voice-options" placeholder="Type to search for a voice..." class="form-control" autocomplete="off">
        <datalist id="voice-options"></datalist>
        <input type="hidden" id="voice_id" name="voice_id">
    </div>

    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Save All Settings</button>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Globals ---
    const form = document.getElementById('settings-form');
    let voices = []; // Keep a cache of voices

    // --- Populators ---
    function populateDevices(selectElement, url, currentId) {
        fetch(url).then(res => res.json()).then(devices => {
            selectElement.innerHTML = '<option value="">Default</option>';
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name;
                if (String(device.id) === String(currentId)) option.selected = true;
                selectElement.appendChild(option);
            });
        });
    }

    // --- Load Initial Data ---
    Promise.all([
        fetch('/api/settings').then(res => res.json()),
        fetch('/api/voices').then(res => res.json())
    ]).then(([settings, voiceData]) => {
        voices = voiceData; // Cache the voices list
        
        // Populate General settings
        document.getElementById('wake-word').value = settings.wake_word || 'jarvis';
        populateDevices(document.getElementById('mic-device'), '/api/microphones', settings.mic_device_id);
        populateDevices(document.getElementById('speaker-device'), '/api/speakers', settings.speaker_device_id);
        
        // --- Populate Voice Datalist ---
        const voiceOptions = document.getElementById('voice-options');
        if (voiceOptions) {
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.dataset.id = voice.id;
                voiceOptions.appendChild(option);
            });
        }
        
        // Set initial value for voice selection
        const voiceNameInput = document.getElementById('voice-name');
        const voiceIdInput = document.getElementById('voice_id');
        
        if (settings.voice_id) {
            const initialVoice = voices.find(v => v.id === settings.voice_id);
            if (initialVoice) {
                voiceNameInput.value = initialVoice.name;
                voiceIdInput.value = initialVoice.id;
            }
        }

    }).catch(error => {
        console.error("Failed to load initial settings:", error);
        alert("There was an error loading page settings. Please try refreshing.");
    });

    // --- Event Listeners ---
    document.getElementById('voice-name').addEventListener('input', (e) => {
        const inputName = e.target.value;
        const voiceIdInput = document.getElementById('voice_id');
        const selectedVoice = voices.find(v => v.name === inputName);
        
        if (selectedVoice) {
            voiceIdInput.value = selectedVoice.id;
        } else {
            // This allows users to type freely without breaking things, but
            // only a valid selection will have an ID.
            voiceIdInput.value = '';
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const settingsToSave = Object.fromEntries(formData.entries());
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settingsToSave)
        }).then(res => {
            if (res.ok) alert('Settings saved successfully!');
            else alert('Failed to save settings.');
        });
    });
});
</script>
{% endblock %} 