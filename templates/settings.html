{% extends "layout.html" %}
{% block title %}Settings & Admin{% endblock %}

{% block content %}
<style>
    /* Tab Navigation */
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }
    .tab-link {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 16px;
        border-bottom: 3px solid transparent;
    }
    .tab-link.active {
        font-weight: bold;
        color: #007bff;
        border-bottom-color: #007bff;
    }

    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Form & List Styles */
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input[type="text"], select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; max-width: 400px; }
    .btn { padding: 0.8rem 1.5rem; border-radius: 4px; border: none; font-size: 1rem; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
    .btn-primary { background-color: #007bff; color: white; }
    .file-list, .tool-list { list-style-type: none; padding-left: 0; }
    .file-list li, .tool-list .card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .tool-list .card h5 { margin-bottom: 5px; }
    .tool-list .card p { font-size: 14px; color: #666; margin-bottom: 0; }
</style>

<h1>Settings &amp; Admin</h1>

<!-- Tab Navigation -->
<div class="tabs">
    <button class="tab-link active" onclick="openTab(event, 'general')">General</button>
    <button class="tab-link" onclick="openTab(event, 'files')">File Manager</button>
    <button class="tab-link" onclick="openTab(event, 'tools')">Tools</button>
</div>

<!-- General Settings Tab -->
<div id="general" class="tab-content active">
    <form id="settings-form">
        <h3>Assistant Settings</h3>
        <div class="form-group">
            <label for="wake-word-select">Wake Word</label>
            <select id="wake-word-select" name="wake_word"></select>
        </div>
        <div class="form-group">
            <label for="mic-device">Microphone</label>
            <select id="mic-device" name="mic_device_id"></select>
        </div>
        <div class="form-group">
            <label for="speaker-device">Speaker</label>
            <select id="speaker-device" name="speaker_device_id"></select>
        </div>
        <hr style="margin: 2rem 0;">
        <h3>Text-to-Speech Voice</h3>
        <div class="form-group">
            <label for="voice-name">Select Voice</label>
            <input type="text" id="voice-name" list="voice-options" placeholder="Type to search for a voice..." autocomplete="off">
            <datalist id="voice-options"></datalist>
            <input type="hidden" id="voice_id" name="voice_id">
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Save All Settings</button>
    </form>
</div>

<!-- File Manager Tab -->
<div id="files" class="tab-content">
    <h3>Project Files</h3>
    <p>View or edit core project files. Be careful with changes.</p>
    <ul class="file-list">
        {% for file in files %}
        <li>
            <code>{{ file }}</code>
            <div>
                <a href="{{ url_for('view_file', filename=file) }}" class="btn">View</a>
                {% if google_auth_status and google_auth_status.email == 'sheldonsadler@gmail.com' %}
                <a href="{{ url_for('edit_file', filename=file) }}" class="btn btn-primary">Edit</a>
                {% endif %}
            </div>
        </li>
        {% else %}
        <li>No editable files found.</li>
        {% endfor %}
    </ul>
</div>

<!-- Tools Tab -->
<div id="tools" class="tab-content">
    <h3>Available Tools</h3>
    <p>These are the functions the AI can use to perform tasks.</p>
    <div class="tool-list">
        {% for tool in tools %}
        <div class="card">
            <div class="card-body">
                <h5>{{ to_friendly_name(tool.function.name) }}</h5>
                <p>{{ tool.function.description }}</p>
            </div>
        </div>
        {% else %}
        <p>No tools are currently loaded.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.addEventListener('DOMContentLoaded', function() {
    // --- Globals ---
    const form = document.getElementById('settings-form');
    let voices = []; // Keep a cache of voices

    // --- Populators ---
    function populateDevices(selectElement, url, currentId) {
        fetch(url).then(res => res.json()).then(devices => {
            selectElement.innerHTML = '<option value="">Default</option>';
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name;
                if (String(device.id) === String(currentId)) option.selected = true;
                selectElement.appendChild(option);
            });
        });
    }

    function populateWakeWords(selectElement, currentWakeWord) {
        fetch('/api/wakewords').then(res => res.json()).then(words => {
            selectElement.innerHTML = ''; // Clear existing options
            words.forEach(word => {
                const option = document.createElement('option');
                option.value = word.toLowerCase().replace(/ /g, '_'); // e.g., "Picovoice" -> "picovoice"
                option.textContent = word;
                if (option.value === currentWakeWord) option.selected = true;
                selectElement.appendChild(option);
            });
        }).catch(error => console.error("Failed to load wake words:", error));
    }

    // --- Load Initial Data ---
    Promise.all([
        fetch('/api/settings').then(res => res.json()),
        fetch('/api/voices').then(res => res.json())
    ]).then(([settings, voiceData]) => {
        voices = voiceData; // Cache the voices list
        
        populateWakeWords(document.getElementById('wake-word-select'), settings.wake_word || 'jarvis');
        populateDevices(document.getElementById('mic-device'), '/api/microphones', settings.mic_device_id);
        populateDevices(document.getElementById('speaker-device'), '/api/speakers', settings.speaker_device_id);
        
        const voiceOptions = document.getElementById('voice-options');
        if (voiceOptions) {
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.dataset.id = voice.id;
                voiceOptions.appendChild(option);
            });
        }
        
        const voiceNameInput = document.getElementById('voice-name');
        const voiceIdInput = document.getElementById('voice_id');
        
        if (settings.voice_id) {
            const initialVoice = voices.find(v => v.id === settings.voice_id);
            if (initialVoice) {
                voiceNameInput.value = initialVoice.name;
                voiceIdInput.value = initialVoice.id;
            }
        }
    }).catch(error => console.error("Failed to load settings:", error));

    // --- Event Listeners ---
    document.getElementById('voice-name').addEventListener('input', (e) => {
        const inputName = e.target.value;
        const voiceIdInput = document.getElementById('voice_id');
        const selectedVoice = voices.find(v => v.name === inputName);
        voiceIdInput.value = selectedVoice ? selectedVoice.id : '';
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const settingsToSave = Object.fromEntries(formData.entries());
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settingsToSave)
        }).then(res => {
            if (res.ok) {
                alert('Settings saved successfully!');
            } else {
                alert('Failed to save settings.');
            }
        });
    });
});
</script>
{% endblock %} 