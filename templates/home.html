<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AERION</title>
    <style>
        /* Basic styles */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #f4f4f9; 
            padding-bottom: 100px; /* Add padding to avoid overlap with fixed dialogue */
        }
        .settings-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #aaa;
            transition: color 0.3s;
        }
        .settings-link:hover {
            color: #333;
        }
        .settings-link svg {
            width: 28px;
            height: 28px;
        }
        .controls { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 20px; 
            width: 90%;
            max-width: 500px; /* Limit width for larger screens */
        }
        .voice-display { 
            font-size: 16px; 
            color: #555; 
            font-style: italic; 
            height: 20px; /* Reserve space to prevent layout shift */
        }

        /* Large Toggle Button Styles */
        .controls #toggle-btn { 
            background-color: #f0f0f0; 
            border: 2px solid #ccc;
            border-radius: 50%; 
            width: 100px;
            height: 100px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: background-color 0.3s, border-color 0.3s;
            padding: 0; /* Reset padding */
        }
        .controls #toggle-btn svg {
            width: 48px;
            height: 48px;
            stroke: #555;
            transition: stroke 0.3s;
        }
        .controls #toggle-btn.running {
            background-color: #e6ffed;
            border-color: #28a745;
        }
        .controls #toggle-btn.running svg {
            stroke: #28a745;
        }
        .controls #toggle-btn.stopped {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .controls #toggle-btn.stopped svg {
            stroke: #6c757d;
        }
        .controls #toggle-btn.listening {
            background-color: #e6ffed;
            border-color: #28a745;
        }
        .controls #toggle-btn.listening svg {
            stroke: #28a745;
        }
        .controls #toggle-btn.conversing {
            background-color: #e0f2ff;
            border-color: #007bff;
        }
        .controls #toggle-btn.conversing svg {
            stroke: #007bff;
        }

        /* Dialogue Box Styles */
        #dialogue-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: none; /* Hide by default */
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            max-width: 100%; /* Override max-width from .controls */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        .dialogue-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 800px; /* Max width for dialogue content */
            margin: 0 auto; /* Center the dialogue box content */
            padding: 5px 0;
            border: none;
            background-color: transparent;
            box-sizing: border-box;
            font-size: 16px;
            color: #444;
            text-align: left;
            min-height: 28px; /* Adjusted height */
        }
        .dialogue-icon {
            flex-shrink: 0;
        }
        .dialogue-icon svg {
            width: 22px;
            height: 22px;
            stroke: #555;
            stroke-width: 1.5;
        }
        #user-speech::before,
        #ai-speech::before {
            content: none; /* Remove the text prefixes */
        }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <a href="{{ url_for('settings') }}" class="settings-link" title="Go to Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </a>
    <div class="controls">
        <h1 id="greeting" style="font-weight: 500; margin-bottom: 10px; color: #333;">
            {% if google_auth_status.status == 'authenticated' and google_auth_status.name %}
                Hi, {{ google_auth_status.name.split(' ')[0] }}!
            {% else %}
                Hello!
            {% endif %}
        </h1>
        <button id="toggle-btn" title="Toggle Assistant Status">
            <svg id="mic-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </button>
        <span id="current-voice-display" class="voice-display"></span>
        <span id="wake-word-display" class="voice-display" style="font-style: normal; font-size: 14px;"></span>
        
        <!-- Real-time Dialogue Box -->
        <div id="dialogue-container">
            <div id="user-speech" class="dialogue-box">
                <span id="user-text"></span>
            </div>
            <div id="ai-speech" class="dialogue-box">
                <span id="ai-text"></span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-btn');
            const voiceDisplay = document.getElementById('current-voice-display');
            const wakeWordDisplay = document.getElementById('wake-word-display');
            const userTextBox = document.getElementById('user-text');
            const aiTextBox = document.getElementById('ai-text');
            const dialogueContainer = document.getElementById('dialogue-container');
            let currentState = 'stopped';

            const socket = io();
            socket.on('connect', () => {
                console.log('Connected to Socket.IO server!');
            });
            
            socket.on('status_update', (data) => {
                console.log('Status update received:', data);
                updateStatus(data);
            });
            
            // New listeners for dialogue
            socket.on('final_transcription', function(data) {
                console.log("Final transcription:", data.text);
                userTextBox.textContent = data.text;
                aiTextBox.textContent = ''; // Clear AI box when user speaks
            });

            socket.on('ai_speech_update', function(data) {
                console.log("AI speech:", data.text);
                dialogueContainer.style.display = 'flex'; // Show container
                aiTextBox.textContent = data.text;
            });

            socket.on('assistant_state_update', function(data) {
                const btn = document.getElementById('toggle-btn');
                // Don't change color if the main state is 'stopped'
                if (currentState === 'stopped') return;

                btn.classList.remove('listening', 'conversing');
                switch (data.state) {
                    case 'listening':
                    case 'idle':
                        btn.classList.add('listening');
                        btn.title = 'Assistant is Listening';
                        break;
                    case 'processing':
                    case 'speaking':
                        btn.classList.add('conversing');
                        btn.title = 'Assistant is in a Conversation';
                        break;
                }
                
                // Handle text box content based on state
                if (data.state === 'idle') {
                     setTimeout(() => {
                        userTextBox.textContent = '';
                        aiTextBox.textContent = '';
                        dialogueContainer.style.display = 'none'; // Hide container
                    }, 1000); // Add a small delay before clearing
                } else if (data.state === 'listening') {
                    dialogueContainer.style.display = 'flex'; // Show for '...'
                    userTextBox.textContent = 'Listening...';
                    aiTextBox.textContent = '';
                }
            });

            function updateStatus(data) {
                currentState = data.status;
                const btn = document.getElementById('toggle-btn');
                btn.classList.remove('running', 'stopped', 'listening', 'conversing');

                if (currentState === 'running') {
                    // When starting, default to listening state
                    btn.classList.add('listening');
                    btn.title = 'Assistant is Running (Click to Stop)';
                } else {
                    btn.classList.add('stopped');
                    btn.title = 'Assistant is Stopped (Click to Start)';
                    // Clear and hide dialogue on stop
                    userTextBox.textContent = '';
                    aiTextBox.textContent = '';
                    dialogueContainer.style.display = 'none';
                }

                if (voiceDisplay && data.voice_name) {
                    if (data.status === 'running' && data.voice_name !== 'Unknown' && data.voice_name !== 'Default') {
                        voiceDisplay.textContent = 'Using voice: ' + data.voice_name;
                    } else {
                        voiceDisplay.textContent = '';
                    }
                }

                if (wakeWordDisplay && data.wake_word) {
                    if (data.status === 'running') {
                        wakeWordDisplay.textContent = `Say "${data.wake_word}"`;
                    } else {
                        wakeWordDisplay.textContent = '';
                    }
                }
            }

            toggleBtn.addEventListener('click', function() {
                const endpoint = currentState === 'running' ? '/stop' : '/start';
                fetch(endpoint, { method: 'POST' });
            });

            // Initial status is sent by the server on connect.
        });
    </script>
</body>
</html> 